services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: openclaw-custom:latest
    container_name: "openclaw-gateway"
    restart: unless-stopped
    init: true

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

    # Node.js 22 undici가 IPv6 우선 시도 → Oracle Cloud에서 fetch 실패
    # Telegram 이미지 다운로드 등 외부 API 호출에 영향
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    dns:
      - 8.8.8.8
      - 8.8.4.4

    # localhost만 바인딩 (SSH 터널로 접근)
    ports:
      - "127.0.0.1:18789:18789"

    env_file: .env
    environment:
      - HOME=/home/node
      - TERM=xterm-256color
      - GOG_KEYRING_PASSWORD=gogcli

    # gateway는 컨테이너 내에서 lan 바인딩 필요
    command: ["node", "openclaw.mjs", "gateway", "--bind", "lan", "--port", "18789"]

    volumes:
      - ./config:/home/node/.openclaw
      # workspace는 config/workspace/로 통합 (별도 마운트 불필요)
      # 지식베이스/코드베이스 (read-only)
      - ~/repos/gh:/home/node/repos/gh:ro
      - ~/repos/work:/home/node/repos/work:ro
      - ~/repos/3rd:/home/node/repos/3rd:rw
      - ~/org:/home/node/org:ro
      # 봇 활동 기록 (rw 오버라이드 — 봇이 Denote 파일 직접 생성)
      - ~/org/botlog:/home/node/org/botlog:rw
      # lifetract DB는 SQLite WAL 필요 → rw 오버라이드 (ro 하위경로)
      - ~/repos/gh/self-tracking-data:/home/node/repos/gh/self-tracking-data:rw
      # Google Workspace CLI (gogcli) 인증 (read-only)
      - ~/.config/gogcli:/home/node/.config/gogcli:ro
      # GitHub CLI 인증 (read-only)
      - ~/.config/gh:/home/node/.config/gh:ro

    networks:
      - default        # CLI 컨테이너와 통신용
      - proxy          # Caddy 리버스 프록시 접근용

  openclaw-cli:
    build:
      context: .
      dockerfile: Dockerfile
    image: openclaw-custom:latest
    container_name: "openclaw-cli"
    profiles: ["cli"]
    stdin_open: true
    tty: true

    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    dns:
      - 8.8.8.8
      - 8.8.4.4

    environment:
      - HOME=/home/node
      - TERM=xterm-256color
      - BROWSER=echo
      - GOG_KEYRING_PASSWORD=gogcli

    entrypoint: ["node", "openclaw.mjs"]

    volumes:
      - ./config:/home/node/.openclaw
      # 지식베이스/코드베이스 (read-only)
      - ~/repos/gh:/home/node/repos/gh:ro
      - ~/repos/work:/home/node/repos/work:ro
      - ~/repos/3rd:/home/node/repos/3rd:rw
      - ~/org:/home/node/org:ro
      # 봇 활동 기록 (rw 오버라이드 — 봇이 Denote 파일 직접 생성)
      - ~/org/botlog:/home/node/org/botlog:rw
      # lifetract DB는 SQLite WAL 필요 → rw 오버라이드 (ro 하위경로)
      - ~/repos/gh/self-tracking-data:/home/node/repos/gh/self-tracking-data:rw
      # Google Workspace CLI (gogcli) 인증 (read-only)
      - ~/.config/gogcli:/home/node/.config/gogcli:ro
      # GitHub CLI 인증 (read-only)
      - ~/.config/gh:/home/node/.config/gh:ro

networks:
  proxy:
    external: true   # Caddy가 생성한 네트워크
