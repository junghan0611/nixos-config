#+title: OpenClaw Docker 배포 가이드 (Oracle VM)
#+date: [2026-02-17 Mon]

* 개요

[[https://openclaw.ai][OpenClaw]] 개인 AI 어시스턴트 게이트웨이.
Oracle Cloud ARM VM에서 Docker로 운영, Telegram으로 모바일 상시 접근.

- Gateway: =ws://127.0.0.1:18789= (SSH 터널 접근)
- 채널: Telegram Bot, Mattermost (https://chat.junghanacs.com)
- 이미지: =ghcr.io/openclaw/openclaw:latest= (ARM64 multi-arch 지원)
- 모델: =anthropic/claude-opus-4-6= (setup-token: Claude 구독 직통, 비용 별도 없음)

* 사전 요구사항

1. Docker + Docker Compose (NixOS =shared.nix= 에서 =virtualisation.docker.enable = true=)
2. Telegram Bot Token (@BotFather에서 생성)
3. Anthropic 계정 (Claude 구독 또는 API Key)
4. NixOS 방화벽: 변경 불필요 (localhost만 바인딩)

* Step 1: Telegram Bot 생성

Telegram에서 [[https://t.me/BotFather][@BotFather]] 접속:

#+begin_example
/newbot
Bot Name: <표시 이름>
Bot Username: <고유 username, _bot으로 끝나야 함>
#+end_example

Bot Token 받기 (예: =1234567890:ABCdefGHIjklMNOpqrsTUVwxyz=)

* Step 2: 디렉토리 구성

#+begin_src bash
# 배포 디렉토리 생성
mkdir -p ~/openclaw/config/credentials
mkdir -p ~/openclaw/config/agents/main/sessions
mkdir -p ~/openclaw/workspace

# docker-compose.yml 복사 (nixos-config 리포에서)
cp ~/nixos-config/docker/openclaw/docker-compose.yml ~/openclaw/
#+end_src

* Step 3: Docker 이미지 풀

#+begin_src bash
cd ~/openclaw
docker pull ghcr.io/openclaw/openclaw:latest
#+end_src

* Step 4: openclaw.json 초기 설정

=openclaw.json.example= 을 기반으로 설정 파일을 생성한다.

#+begin_src bash
cp ~/nixos-config/docker/openclaw/openclaw.json.example ~/openclaw/config/openclaw.json
#+end_src

편집하여 토큰 입력:

#+begin_src bash
# Gateway 토큰 생성
openssl rand -hex 24
# 출력값을 openclaw.json의 gateway.auth.token에 입력

# Telegram Bot Token을 channels.telegram.botToken에 입력
#+end_src

=~/openclaw/config/openclaw.json= 에서 교체할 값:
- =<TELEGRAM_BOT_TOKEN>= → @BotFather에서 받은 토큰
- =<GATEWAY_TOKEN>= → =openssl rand -hex 24= 출력값

보안:

#+begin_src bash
chmod 700 ~/openclaw/config
#+end_src

*주의*: =channels add --channel telegram= CLI는 동작하지 않음.
Telegram 채널은 반드시 =openclaw.json= 에 직접 설정해야 함.

* Step 5: 비대화형 온보딩 (구조 초기화)

#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli onboard \
  --non-interactive \
  --accept-risk \
  --flow quickstart \
  --auth-choice skip \
  --skip-channels \
  --skip-skills \
  --skip-daemon \
  --skip-ui \
  --skip-health \
  --gateway-bind lan \
  --gateway-port 18789 \
  --json
#+end_src

이 단계는 워크스페이스 구조(AGENTS.md, SOUL.md 등)를 생성한다.
Gateway가 =openclaw.json= 을 덮어쓸 수 있으므로, Step 4의 설정이 유지되는지 확인.

* Step 6: Anthropic 인증 (대화형)

#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli onboard \
  --flow quickstart \
  --auth-choice setup-token \
  --skip-channels \
  --skip-skills \
  --skip-daemon \
  --skip-ui
#+end_src

인증 방식 옵션:
- =setup-token=: Claude 구독 계정 토큰 (권장)
- =oauth=: OAuth 브라우저 인증
- =anthropic-api-key=: API Key 직접 입력

대화형 프롬프트에서 Hooks 선택:
- =boot-md=: 세션 시작 시 시스템 프롬프트 자동 로드
- =session-memory=: =/new= 시 세션 컨텍스트를 메모리에 저장

* Step 7: Gateway 기동

#+begin_src bash
cd ~/openclaw
docker compose up -d openclaw-gateway
#+end_src

로그 확인:

#+begin_src bash
docker logs openclaw-gateway --tail 20
#+end_src

정상 기동 확인 메시지:

#+begin_example
[gateway]    agent model: anthropic/claude-opus-4-6
[gateway]    listening on ws://0.0.0.0:18789
[hooks]      loaded 4 internal hook handlers
[telegram]   [default] starting provider (@<your_bot_username>)
#+end_example

* Step 8: Telegram 페어링

1. Telegram에서 봇에게 아무 메시지 전송
2. 봇이 pairing code를 응답함:
   #+begin_example
   Pairing code: XXXXXXX
   #+end_example
3. 승인:
   #+begin_src bash
   cd ~/openclaw
   docker compose run --rm openclaw-cli pairing approve telegram XXXXXXX
   #+end_src
4. 다시 Telegram에서 메시지 전송 → 봇이 응답하면 완료!

* Step 9: USER.md 커스텀 (선택)

=~/openclaw/workspace/USER.md= 를 편집하여 사용자 정보를 기록.
봇이 세션 시작 시 이 파일을 읽고 사용자 컨텍스트를 파악한다.

포함할 내용:
- 이름, 언어, 타임존
- 환경 (OS, 도구)
- 컨테이너 내부 데이터 경로 (=/data/repos/gh=, =/data/org= 등)

* Mattermost 채널 연동

Mattermost는 OpenClaw 내장 채널 (별도 플러그인 불필요).

** 사전 요구사항

- Mattermost 인스턴스 운영 중 (=chat.junghanacs.com=)
- System Console → Integrations → Bot Accounts → Enable: YES

** 봇 계정 생성

Mattermost System Console → Integrations → Bot Accounts → Add:

- Username: =openclaw=
- Display Name: =OpenClaw AI=
- Role: Member (User 권한으로 충분)

토큰 발급 (한 번만 표시됨). =openclaw.json= 에 입력:

#+begin_src json
{
  "channels": {
    "mattermost": {
      "enabled": true,
      "botToken": "<MATTERMOST_BOT_TOKEN>",
      "baseUrl": "https://chat.junghanacs.com",
      "dmPolicy": "pairing"
    }
  }
}
#+end_src

Gateway 재시작 후 정상 로그:

#+begin_example
[mattermost] [default] starting channel
[mattermost] connected as @openclaw
#+end_example

** 사용자 페어링

DM 전송 → 봇이 페어링 코드 응답:

#+begin_example
openclaw pairing approve mattermost <CODE>
#+end_example

또는:

#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli pairing approve mattermost <CODE>
#+end_src

* 멀티 에이전트 (고급)

OpenClaw는 채널별 독립 에이전트 라우팅 지원.
각 에이전트마다 별도 워크스페이스, 모델, 페르소나 설정 가능.

** Step 1: 채널 계정 추가

#+begin_src bash
# 두 번째 Telegram 봇 계정 추가 (account id: glg)
docker compose run --rm openclaw-cli channels add \
  --channel telegram \
  --account glg \
  --token '<TELEGRAM_BOT_TOKEN>' \
  --name '힣(glg)'
#+end_src

** Step 2: 에이전트 생성

#+begin_src bash
# 에이전트 추가 (--bind 는 CLI standalone에서 동작 안 함 → Step 3에서 config 직접 수정)
docker compose run --rm openclaw-cli agents add glg \
  --model anthropic/claude-opus-4-6 \
  --workspace /home/node/.openclaw/workspace-glg \
  --non-interactive --json
#+end_src

** Step 3: 바인딩 설정 (⚠️ config 직접 수정 필수)

*중요*: =--bind= 플래그는 Gateway가 없는 standalone CLI에서 동작하지 않음.
=channels add= 성공 후에도 마찬가지. 바인딩은 반드시 =openclaw.json= 루트에 직접 추가.

에이전트/채널 바인딩은 *agents 내부가 아닌 루트 레벨* =bindings= 배열에 설정:

#+begin_src json
{
  "bindings": [
    {
      "agentId": "glg",
      "match": { "channel": "telegram", "accountId": "glg" }
    }
  ]
}
#+end_src

config 파일이 변경되면 Gateway가 hot reload로 자동 반영:

#+begin_example
[reload] config change applied (dynamic reads: agents.list, bindings)
#+end_example

** 채널 바인딩 예시

| 채널 | 계정 ID | 에이전트 | 용도 |
|------|---------|----------|------|
| telegram | default | main | 개인 어시스턴트 |
| telegram | glg | glg | 힣(glg) 디지털 가든 안내자 |
| mattermost | default | main | 자동화 허브 |

에이전트별로 SOUL.md, USER.md, 도구 권한을 다르게 설정 가능.

* SSH 터널링 + 대시보드 접속

** SSH 터널 (로컬 머신에서)

#+begin_src bash
ssh -N -L 18789:127.0.0.1:18789 <user>@<oracle-vm-ip>
#+end_src

브라우저: =http://127.0.0.1:18789/=

** Device Pairing (첫 접속 시 필수)

브라우저에서 접속하면 "disconnected (1008): pairing required" 표시됨.
Docker 컨테이너 내부에서는 SSH 터널도 bridge IP(172.x.x.x)로 보이므로
auto-approval이 작동하지 않음. 수동 승인 필요:

*방법 1*: gateway 컨테이너 내부에서 직접 실행 (권장):

#+begin_src bash
# 브라우저에서 대시보드 접속 시도 (1008 에러 발생)
# pending request 확인:
docker exec openclaw-gateway node openclaw.mjs devices list

# 출력된 Request ID로 승인:
docker exec openclaw-gateway node openclaw.mjs devices approve <requestId>
#+end_src

*방법 2*: CLI 컨테이너에서 gateway URL + token 명시:

#+begin_src bash
GATEWAY_TOKEN="<your-gateway-token>"

docker compose run --rm openclaw-cli devices list \
  --url ws://openclaw-gateway:18789 \
  --token "$GATEWAY_TOKEN"

docker compose run --rm openclaw-cli devices approve <requestId> \
  --url ws://openclaw-gateway:18789 \
  --token "$GATEWAY_TOKEN"
#+end_src

승인 후 대시보드에서 토큰 입력 창에 =gateway.auth.token= 값 입력.
같은 브라우저 프로필이면 재승인 불필요.

*주의*: =docker compose run --rm openclaw-cli devices list= (플래그 없이)는
CLI 컨테이너가 자기 자신 IP로 연결 시도하여 실패함. 반드시 =--url= 명시.

* 관리

#+begin_src bash
cd ~/openclaw

# 재시작
docker compose restart openclaw-gateway

# 로그
docker compose logs --tail=30 openclaw-gateway

# 중지
docker compose down

# CLI 접근 (게이트웨이 연결 필요한 명령은 --url --token 명시)
docker exec openclaw-gateway node openclaw.mjs <command>

# 업데이트
docker compose pull && docker compose up -d openclaw-gateway
#+end_src

* 데이터 경로

| 호스트 경로                            | 컨테이너 경로                   | 용도         |
|----------------------------------------+---------------------------------+--------------|
| =~/openclaw/config/openclaw.json=      | =/home/node/.openclaw/=         | 설정 (rw)    |
| =~/openclaw/workspace/=                | =/home/node/.openclaw/workspace= | 워크스페이스 |
| =~/openclaw/config/credentials/=       | =/home/node/.openclaw/credentials= | 인증 (rw) |
| =~/repos/gh=                           | =/data/repos/gh=                | 개인 리포 (ro) |
| =~/repos/work=                         | =/data/repos/work=              | 회사 리포 (ro) |
| =~/org=                                | =/data/org=                     | 지식베이스 (ro) |

* 포트 현황 (Oracle VM)

| Port  | Service    | Binding   | 방화벽 |
|-------+------------+-----------+--------|
| 22    | SSH        | 0.0.0.0   | open   |
| 80    | Caddy      | 0.0.0.0   | open   |
| 443   | Caddy      | 0.0.0.0   | open   |
| 5432  | Postgres   | internal  | closed |
| 8065  | Mattermost | internal  | closed |
| 8080  | Remark42   | internal  | closed |
| 8384  | Syncthing  | 127.0.0.1 | closed |
| 18789 | OpenClaw   | 127.0.0.1 | closed |
| 22000 | Syncthing  | 0.0.0.0   | open   |

* 트러블슈팅

** =Unknown channel: telegram=
=channels add --channel telegram= CLI는 동작하지 않음.
=openclaw.json= 에 직접 =channels.telegram= 섹션을 설정해야 함.
=openclaw.json.example= 참고.

** =Gateway auth is set to token, but no token is configured=
=openclaw.json= 의 =gateway.auth.token= 에 토큰이 누락됨.
=openssl rand -hex 24= 로 생성하여 입력.

** =HTTP 401: authentication_error: Invalid bearer token=
Anthropic 인증이 안 됨. Step 6을 다시 실행:
=docker compose run --rm openclaw-cli onboard --auth-choice setup-token --skip-channels --skip-skills --skip-daemon --skip-ui=

** =disconnected (1008): pairing required= (대시보드 접속 시)
Docker 컨테이너 내부에서 SSH 터널 연결도 bridge IP(172.x.x.x)로 보여
auto-approval이 작동하지 않음. Device pairing 섹션의 방법 1 참고.

#+begin_src bash
docker exec openclaw-gateway node openclaw.mjs devices list
docker exec openclaw-gateway node openclaw.mjs devices approve <requestId>
#+end_src

** =gateway closed (1006)= (CLI 컨테이너에서 명령 실행 시)
CLI 컨테이너가 자기 자신 IP로 gateway 연결 시도하여 실패하는 정상 현상.
두 가지 해결책:
1. =docker exec openclaw-gateway node openclaw.mjs <command>= 사용
2. =--url ws://openclaw-gateway:18789 --token <token>= 플래그 명시

** Systemd unavailable
Docker 컨테이너 내부에는 systemd가 없음. 정상 동작이며 무시 가능.
Gateway는 =docker compose up -d= 로 관리.
