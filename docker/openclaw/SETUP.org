#+title: OpenClaw Docker 배포 가이드 (Oracle VM)
#+date: [2026-02-17 Mon]

* 개요

[[https://openclaw.ai][OpenClaw]] 개인 AI 어시스턴트 게이트웨이.
Oracle Cloud ARM VM에서 Docker로 운영, Telegram으로 모바일 상시 접근.

- Gateway: =ws://127.0.0.1:18789= (SSH 터널 접근)
- 채널: Telegram Bot, Mattermost (https://chat.junghanacs.com)
- 이미지: =openclaw-custom:latest= (Dockerfile로 빌드, 기반: =ghcr.io/openclaw/openclaw:latest=)
- 모델: =anthropic/claude-opus-4-6= (setup-token: Claude 구독 직통, 비용 별도 없음)
- 추가 도구: ripgrep, fd, jq, tree (에이전트 탐색·분석용)

* 사전 요구사항

1. Docker + Docker Compose (NixOS =shared.nix= 에서 =virtualisation.docker.enable = true=)
2. Telegram Bot Token (@BotFather에서 생성)
3. Anthropic 계정 (Claude 구독 또는 API Key)
4. NixOS 방화벽: 변경 불필요 (localhost만 바인딩)

* Step 1: Telegram Bot 생성

Telegram에서 [[https://t.me/BotFather][@BotFather]] 접속:

#+begin_example
/newbot
Bot Name: <표시 이름>
Bot Username: <고유 username, _bot으로 끝나야 함>
#+end_example

Bot Token 받기 (예: =1234567890:ABCdefGHIjklMNOpqrsTUVwxyz=)

* Step 2: 디렉토리 구성

#+begin_src bash
# 배포 디렉토리 생성
mkdir -p ~/openclaw/config/credentials
mkdir -p ~/openclaw/config/agents/main/sessions
mkdir -p ~/openclaw/workspace

# docker-compose.yml 복사 (nixos-config 리포에서)
cp ~/nixos-config/docker/openclaw/docker-compose.yml ~/openclaw/
#+end_src

* Step 3: Docker 이미지 빌드

커스텀 =Dockerfile= 로 빌드 (ripgrep, fd, jq, tree 포함):

#+begin_src bash
cd ~/openclaw
# Dockerfile, docker-compose.yml 복사
cp ~/nixos-config/docker/openclaw/Dockerfile ~/openclaw/

# 빌드 (최초 1회, 업데이트 시도 재실행)
docker compose build
#+end_src

업스트림 이미지 업데이트 시:
#+begin_src bash
cd ~/openclaw
docker compose pull && docker compose build && docker compose up -d openclaw-gateway
#+end_src

* Step 4: openclaw.json 초기 설정

=openclaw.json.example= 을 기반으로 설정 파일을 생성한다.

#+begin_src bash
cp ~/nixos-config/docker/openclaw/openclaw.json.example ~/openclaw/config/openclaw.json
#+end_src

편집하여 토큰 입력:

#+begin_src bash
# Gateway 토큰 생성
openssl rand -hex 24
# 출력값을 openclaw.json의 gateway.auth.token에 입력

# Telegram Bot Token을 channels.telegram.botToken에 입력
#+end_src

=~/openclaw/config/openclaw.json= 에서 교체할 값:
- =<TELEGRAM_BOT_TOKEN>= → @BotFather에서 받은 토큰
- =<GATEWAY_TOKEN>= → =openssl rand -hex 24= 출력값

보안:

#+begin_src bash
chmod 700 ~/openclaw/config
#+end_src

*주의*: =channels add --channel telegram= CLI는 동작하지 않음.
Telegram 채널은 반드시 =openclaw.json= 에 직접 설정해야 함.

* Step 5: 비대화형 온보딩 (구조 초기화)

#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli onboard \
  --non-interactive \
  --accept-risk \
  --flow quickstart \
  --auth-choice skip \
  --skip-channels \
  --skip-skills \
  --skip-daemon \
  --skip-ui \
  --skip-health \
  --gateway-bind lan \
  --gateway-port 18789 \
  --json
#+end_src

이 단계는 워크스페이스 구조(AGENTS.md, SOUL.md 등)를 생성한다.
Gateway가 =openclaw.json= 을 덮어쓸 수 있으므로, Step 4의 설정이 유지되는지 확인.

* Step 6: Anthropic 인증 (대화형)

#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli onboard \
  --flow quickstart \
  --auth-choice setup-token \
  --skip-channels \
  --skip-skills \
  --skip-daemon \
  --skip-ui
#+end_src

인증 방식 옵션:
- =setup-token=: Claude 구독 계정 토큰 (권장)
- =oauth=: OAuth 브라우저 인증
- =anthropic-api-key=: API Key 직접 입력

대화형 프롬프트에서 Hooks 선택:
- =boot-md=: 세션 시작 시 시스템 프롬프트 자동 로드
- =session-memory=: =/new= 시 세션 컨텍스트를 메모리에 저장

* Step 7: Gateway 기동

#+begin_src bash
cd ~/openclaw
docker compose up -d openclaw-gateway
#+end_src

로그 확인:

#+begin_src bash
docker logs openclaw-gateway --tail 20
#+end_src

정상 기동 확인 메시지:

#+begin_example
[gateway]    agent model: anthropic/claude-opus-4-6
[gateway]    listening on ws://0.0.0.0:18789
[hooks]      loaded 4 internal hook handlers
[telegram]   [default] starting provider (@<your_bot_username>)
#+end_example

* Step 8: Telegram 페어링

1. Telegram에서 봇에게 아무 메시지 전송
2. 봇이 pairing code를 응답함:
   #+begin_example
   Pairing code: XXXXXXX
   #+end_example
3. pending 요청 확인:
   #+begin_src bash
   # default 봇
   docker exec openclaw-gateway node openclaw.mjs pairing list --channel telegram

   # 특정 계정 (멀티계정 모드)
   docker exec openclaw-gateway node openclaw.mjs pairing list --channel telegram --account glg
   #+end_src
4. 승인:
   #+begin_src bash
   # default 봇
   docker exec openclaw-gateway node openclaw.mjs pairing approve telegram <CODE>

   # 특정 계정 (멀티계정 모드)
   docker exec openclaw-gateway node openclaw.mjs pairing approve telegram <CODE> --account glg
   #+end_src
5. 다시 Telegram에서 메시지 전송 → 봇이 응답하면 완료!

*참고*: =run.sh= 의 =p) 페어링 승인= 메뉴로 간편하게 실행 가능.

* Step 9: USER.md 커스텀 (선택)

=~/openclaw/workspace/USER.md= 를 편집하여 사용자 정보를 기록.
봇이 세션 시작 시 이 파일을 읽고 사용자 컨텍스트를 파악한다.

포함할 내용:
- 이름, 언어, 타임존
- 환경 (OS, 도구)
- 컨테이너 내부 데이터 경로 (=/data/repos/gh=, =/data/org= 등)

* Step 10: 에이전트 스킬 설정 (⚠️ 중요 — 특히 default)

OpenClaw 에이전트는 스킬(Skill) 단위로 도구 권한을 관리한다.
기본 설치만으로는 에이전트가 파일 읽기, 코드 실행 등을 못 한다.
*default(main) 에이전트는 가장 많이 사용하므로 스킬 설정에 특별히 신경 써야 한다.*

** 스킬 현황 확인

#+begin_src bash
docker exec openclaw-gateway node openclaw.mjs skills list
#+end_src

** 핵심 스킬 목록

| 스킬           | 용도                                      | 우선순위 |
|----------------+-------------------------------------------+----------|
| =computer=     | 파일 읽기/쓰기, 셸 명령 실행             | 필수     |
| =web-search=   | 웹 검색 (Brave/Tavily API 필요)           | 권장     |
| =web-fetch=    | URL 내용 가져오기                         | 권장     |
| =memory=       | 장기 기억 저장/조회                       | 권장     |
| =github=       | GitHub 이슈/PR 조작                       | 선택     |
| =image-gen=    | 이미지 생성 (별도 API 필요)               | 선택     |

** default(main) 에이전트 스킬 설정

대화형으로 스킬 활성화:
#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli skills setup
#+end_src

또는 =openclaw.json= 에 직접 설정:
#+begin_src json
{
  "agents": {
    "list": [
      {
        "id": "main",
        "model": "anthropic/claude-opus-4-6",
        "skills": {
          "computer": { "enabled": true },
          "web-fetch": { "enabled": true }
        }
      }
    ]
  }
}
#+end_src

** 컨테이너 내 탐색 도구 (Dockerfile에 포함)

에이전트가 사용할 수 있는 시스템 도구:

| 도구      | 명령  | 용도                                  |
|-----------+-------+---------------------------------------|
| ripgrep   | =rg=  | 빠른 텍스트 검색 — org/코드 탐색 핵심 |
| fd        | =fd=  | 빠른 파일 찾기                        |
| jq        | =jq=  | JSON 파싱/변환                        |
| tree      | =tree= | 디렉토리 구조 파악                   |

이 도구들은 =Dockerfile= 에서 설치되므로 이미지 재빌드로 항상 유지된다.

** glg 에이전트 스킬 설정

glg 에이전트는 디지털 가든 안내자 역할. main과 별도로 스킬 설정 가능:
#+begin_src json
{
  "agents": {
    "list": [
      {
        "id": "glg",
        "model": "anthropic/claude-opus-4-6",
        "skills": {
          "computer": { "enabled": true },
          "web-fetch": { "enabled": true }
        }
      }
    ]
  }
}
#+end_src

*TODO*: 실제 사용 패턴에 따라 스킬 추가 예정.
- [ ] web-search 연동 (Brave Search API 또는 Tavily)
- [ ] memory 스킬 설정 (장기 기억 저장소 경로 확정 후)
- [ ] github 스킬 연동 (개인/업무 리포 접근 권한 분리)
- [ ] default 에이전트: =~/org= 탐색용 rg/fd 활용 워크플로우 정립

* Mattermost 채널 연동

Mattermost는 OpenClaw 내장 채널 (별도 플러그인 불필요).

** 사전 요구사항

- Mattermost 인스턴스 운영 중 (=chat.junghanacs.com=)
- System Console → Integrations → Bot Accounts → Enable: YES

** 봇 계정 생성

Mattermost System Console → Integrations → Bot Accounts → Add:

- Username: =openclaw=
- Display Name: =OpenClaw AI=
- Role: Member (User 권한으로 충분)

토큰 발급 (한 번만 표시됨). =openclaw.json= 에 입력:

#+begin_src json
{
  "channels": {
    "mattermost": {
      "enabled": true,
      "botToken": "<MATTERMOST_BOT_TOKEN>",
      "baseUrl": "https://chat.junghanacs.com",
      "dmPolicy": "pairing"
    }
  }
}
#+end_src

Gateway 재시작 후 정상 로그:

#+begin_example
[mattermost] [default] starting channel
[mattermost] connected as @openclaw
#+end_example

** 사용자 페어링

DM 전송 → 봇이 페어링 코드 응답:

#+begin_example
openclaw pairing approve mattermost <CODE>
#+end_example

또는:

#+begin_src bash
cd ~/openclaw
docker compose run --rm openclaw-cli pairing approve mattermost <CODE>
#+end_src

* 멀티 에이전트 (고급)

OpenClaw는 채널별 독립 에이전트 라우팅 지원.
각 에이전트마다 별도 워크스페이스, 모델, 페르소나 설정 가능.

** Step 1: 채널 계정 추가

#+begin_src bash
# 두 번째 Telegram 봇 계정 추가 (account id: glg)
docker compose run --rm openclaw-cli channels add \
  --channel telegram \
  --account glg \
  --token '<TELEGRAM_BOT_TOKEN>' \
  --name '힣(glg)'
#+end_src

** Step 2: 에이전트 생성

#+begin_src bash
# 에이전트 추가 (--bind 는 CLI standalone에서 동작 안 함 → Step 3에서 config 직접 수정)
docker compose run --rm openclaw-cli agents add glg \
  --model anthropic/claude-opus-4-6 \
  --workspace /home/node/.openclaw/workspace-glg \
  --non-interactive --json
#+end_src

** Step 2-5: ⚠️ default 계정도 accounts에 명시 필수

Telegram =accounts= 에 항목이 하나라도 생기면 OpenClaw는 *멀티 계정 모드*로 전환.
이 모드에서는 =accounts= 에 명시된 계정만 시작되며, root-level =botToken= 은 무시됨.
따라서 *default 봇도 반드시 =accounts.default= 에 추가*해야 함:

#+begin_src json
{
  "channels": {
    "telegram": {
      "botToken": "<DEFAULT_TOKEN>",
      "accounts": {
        "default": {
          "enabled": true,
          "botToken": "<DEFAULT_TOKEN>",
          "dmPolicy": "pairing",
          "groupPolicy": "allowlist",
          "streamMode": "partial"
        },
        "glg": {
          "enabled": true,
          "botToken": "<GLG_TOKEN>",
          ...
        }
      }
    }
  }
}
#+end_src

** Step 3: 바인딩 설정 (⚠️ config 직접 수정 필수)

*중요*: =--bind= 플래그는 Gateway가 없는 standalone CLI에서 동작하지 않음.
=channels add= 성공 후에도 마찬가지. 바인딩은 반드시 =openclaw.json= 루트에 직접 추가.

에이전트/채널 바인딩은 *agents 내부가 아닌 루트 레벨* =bindings= 배열에 설정:

#+begin_src json
{
  "bindings": [
    {
      "agentId": "glg",
      "match": { "channel": "telegram", "accountId": "glg" }
    }
  ]
}
#+end_src

config 파일이 변경되면 Gateway가 hot reload로 자동 반영:

#+begin_example
[reload] config change applied (dynamic reads: agents.list, bindings)
#+end_example

** 채널 바인딩 예시

| 채널 | 계정 ID | 에이전트 | 용도 |
|------|---------|----------|------|
| telegram | default | main | 개인 어시스턴트 |
| telegram | glg | glg | 힣(glg) 디지털 가든 안내자 |
| mattermost | default | main | 자동화 허브 |

에이전트별로 SOUL.md, USER.md, 도구 권한을 다르게 설정 가능.

** ⚠️ 세션 격리 (=session.dmScope=) — 멀티유저 봇의 핵심

*기본값 =main= 에서는 모든 사용자의 DM이 하나의 세션으로 합쳐진다.*
A 사용자와의 대화 내용이 B 사용자 세션에 그대로 노출되고,
봇이 모든 사용자를 동일인으로 착각한다.

*공개 봇(glg 등 여러 사용자 대상)은 반드시 =per-account-channel-peer= 로 변경해야 한다.*

=openclaw.json= 최상위 레벨에 설정:

#+begin_src json
{
  "session": {
    "dmScope": "per-account-channel-peer"
  }
}
#+end_src

| =dmScope= 값 | 세션 키 형식 | 용도 |
|---------------+--------------+------|
| =main= (기본) | =agent:<agentId>:main= | 개인 전용 (1인 사용) |
| =per-peer= | =agent:<agentId>:dm:<userId>= | 채널 무관 사용자별 |
| =per-channel-peer= | =agent:<agentId>:<channel>:dm:<userId>= | 채널+사용자별 |
| =per-account-channel-peer= | =agent:<agentId>:<channel>:<accountId>:dm:<userId>= | 계정+채널+사용자별 *(권장)* |

참고: [[https://docs.openclaw.ai/concepts/session]]

*** 적용 후 기존 세션 정리

=dmScope= 변경 후에는 기존 단일 세션을 백업/삭제해야 새 키로 세션이 생성된다:

#+begin_src bash
cd ~/openclaw/config/agents/glg/sessions
mv sessions.json sessions.json.bak
mv *.jsonl *.jsonl.bak
#+end_src

Gateway 재시작하면 각 사용자별 독립 세션이 자동 생성된다.

*** USER.md 멀티유저 대응

=dmScope= 변경과 함께 에이전트의 =USER.md= 도 변경 필수.
특정 사용자 하드코딩(=Name: 정한=) 대신 멀티유저 구조로:

#+begin_example
## 사용자 식별

각 텔레그램 DM은 사용자별 독립 세션이다.
메시지의 발신자 정보(이름, username, user id)로 사용자를 식별한다.

## 알려진 사용자

| 이름 | Telegram ID | 관계 | 호칭 |
|------|------------|------|------|
| 정한 | 123861330 | 봇 운영자 | 힣님 |
| 김현진 | 81880552 | 가족 | 현진님 |
#+end_example

* SSH 터널링 + 대시보드 접속

** SSH 터널 (로컬 머신에서)

#+begin_src bash
ssh -N -L 18789:127.0.0.1:18789 <user>@<oracle-vm-ip>
#+end_src

브라우저: =http://127.0.0.1:18789/=

** Device Pairing (첫 접속 시 필수)

브라우저에서 접속하면 "disconnected (1008): pairing required" 표시됨.
Docker 컨테이너 내부에서는 SSH 터널도 bridge IP(172.x.x.x)로 보이므로
auto-approval이 작동하지 않음. 수동 승인 필요:

*방법 1*: gateway 컨테이너 내부에서 직접 실행 (권장):

#+begin_src bash
# 브라우저에서 대시보드 접속 시도 (1008 에러 발생)
# pending request 확인:
docker exec openclaw-gateway node openclaw.mjs devices list

# 출력된 Request ID로 승인:
docker exec openclaw-gateway node openclaw.mjs devices approve <requestId>
#+end_src

*방법 2*: CLI 컨테이너에서 gateway URL + token 명시:

#+begin_src bash
GATEWAY_TOKEN="<your-gateway-token>"

docker compose run --rm openclaw-cli devices list \
  --url ws://openclaw-gateway:18789 \
  --token "$GATEWAY_TOKEN"

docker compose run --rm openclaw-cli devices approve <requestId> \
  --url ws://openclaw-gateway:18789 \
  --token "$GATEWAY_TOKEN"
#+end_src

승인 후 대시보드에서 토큰 입력 창에 =gateway.auth.token= 값 입력.
같은 브라우저 프로필이면 재승인 불필요.

*주의*: =docker compose run --rm openclaw-cli devices list= (플래그 없이)는
CLI 컨테이너가 자기 자신 IP로 연결 시도하여 실패함. 반드시 =--url= 명시.

* 관리

#+begin_src bash
cd ~/openclaw

# 재시작
docker compose restart openclaw-gateway

# 로그
docker compose logs --tail=30 openclaw-gateway

# 중지
docker compose down

# CLI 접근 (게이트웨이 연결 필요한 명령은 --url --token 명시)
docker exec openclaw-gateway node openclaw.mjs <command>

# 업데이트 (커스텀 이미지 재빌드 포함)
docker compose pull && docker compose build && docker compose up -d openclaw-gateway
#+end_src

* 데이터 경로

배포 디렉토리: =~/openclaw/= → =~/sync/family/openclaw/= 심볼릭링크
(Syncthing으로 기기간 동기화, private git으로 버전 관리)

| 호스트 경로                                 | 컨테이너 경로                         | 용도           |
|---------------------------------------------+---------------------------------------+----------------|
| =~/openclaw/config/=                        | =/home/node/.openclaw/=               | 전체 설정 (rw) |
| =~/openclaw/config/workspace/=              | =/home/node/.openclaw/workspace=      | main 워크스페이스 |
| =~/openclaw/config/workspace-glg/=          | =/home/node/.openclaw/workspace-glg=  | glg 워크스페이스 |
| =~/openclaw/config/credentials/=            | =/home/node/.openclaw/credentials=    | 인증 (rw)      |
| =~/repos/gh=                                | =/data/repos/gh=                      | 개인 리포 (ro) |
| =~/repos/work=                              | =/data/repos/work=                    | 회사 리포 (ro) |
| =~/org=                                     | =/data/org=                           | 지식베이스 (ro) |

* 포트 현황 (Oracle VM)

| Port  | Service    | Binding   | 방화벽 |
|-------+------------+-----------+--------|
| 22    | SSH        | 0.0.0.0   | open   |
| 80    | Caddy      | 0.0.0.0   | open   |
| 443   | Caddy      | 0.0.0.0   | open   |
| 5432  | Postgres   | internal  | closed |
| 8065  | Mattermost | internal  | closed |
| 8080  | Remark42   | internal  | closed |
| 8384  | Syncthing  | 127.0.0.1 | closed |
| 18789 | OpenClaw   | 127.0.0.1 | closed |
| 22000 | Syncthing  | 0.0.0.0   | open   |

* 트러블슈팅

** =Unknown channel: telegram=
=channels add --channel telegram= CLI는 동작하지 않음.
=openclaw.json= 에 직접 =channels.telegram= 섹션을 설정해야 함.
=openclaw.json.example= 참고.

** =Gateway auth is set to token, but no token is configured=
=openclaw.json= 의 =gateway.auth.token= 에 토큰이 누락됨.
=openssl rand -hex 24= 로 생성하여 입력.

** =HTTP 401: authentication_error: Invalid bearer token=
Anthropic 인증이 안 됨. Step 6을 다시 실행:
=docker compose run --rm openclaw-cli onboard --auth-choice setup-token --skip-channels --skip-skills --skip-daemon --skip-ui=

** =disconnected (1008): pairing required= (대시보드 접속 시)
Docker 컨테이너 내부에서 SSH 터널 연결도 bridge IP(172.x.x.x)로 보여
auto-approval이 작동하지 않음. Device pairing 섹션의 방법 1 참고.

#+begin_src bash
docker exec openclaw-gateway node openclaw.mjs devices list
docker exec openclaw-gateway node openclaw.mjs devices approve <requestId>
#+end_src

** =gateway closed (1006)= (CLI 컨테이너에서 명령 실행 시)
CLI 컨테이너가 자기 자신 IP로 gateway 연결 시도하여 실패하는 정상 현상.
두 가지 해결책:
1. =docker exec openclaw-gateway node openclaw.mjs <command>= 사용
2. =--url ws://openclaw-gateway:18789 --token <token>= 플래그 명시

** Systemd unavailable
Docker 컨테이너 내부에는 systemd가 없음. 정상 동작이며 무시 가능.
Gateway는 =docker compose up -d= 로 관리.

** Telegram default 봇 응답 없음 (=0/1 connected, 0 enabled=)
원인: =agents.list= 의 main 에이전트에 =model= 미설정.
onboard 과정에서 model이 자동 설정되지 않고 agents.list도 생성되지 않을 수 있음.

확인:
#+begin_src bash
docker exec openclaw-gateway cat /home/node/.openclaw/openclaw.json | \
  python3 -c "import json,sys; c=json.load(sys.stdin); \
  [print(a['id'], a.get('model','없음')) for a in c['agents']['list']]"
#+end_src

수정: =openclaw.json= 에 직접 추가 (Gateway hot reload로 자동 반영):
#+begin_src json
{
  "agents": {
    "list": [
      {
        "id": "main",
        "model": "anthropic/claude-opus-4-6"
      }
    ]
  }
}
#+end_src

재현 방지: =openclaw.json.example= 에 =agents.list[main].model= 포함.
