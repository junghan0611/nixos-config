#!/usr/bin/env bash
# GLG (힣) - Junghan's Developer Toolbox
# 사용법: glg
# 설명: 인터랙티브 메뉴로 개발 도구 모음 실행
#   - Git 리포지토리 리뷰 및 Pull
#   - 현재 디렉토리 Git Pull
#   - 시스템 정보 확인
#   - 확장 가능한 도구 모음 인터페이스

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPOS_GH="$HOME/repos/gh"
REPOS_WORK="$HOME/repos/work"
REPOS_3RD="$HOME/repos/3rd"

# Helper functions
info() { echo -e "${BLUE}ℹ ${NC}$1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; }

# Check tool availability
check_tool() {
    local tool="$1"
    if ! command -v "$tool" &> /dev/null; then
        error "필수 도구가 없습니다: $tool"
        return 1
    fi
    return 0
}

# Show menu
show_menu() {
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo -e "${CYAN}GLG (힣) Toolbox${NC} - ${MAGENTA}Developer Tools${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo -e "  ${YELLOW}Git Tools${NC}"
    echo "    1) Git Review - repos/gh (개인 프로젝트)"
    echo "    2) Git Review - repos/work (회사 프로젝트)"
    echo "    3) Git Review - repos/3rd (외부 오픈소스)"
    echo "    4) Git Review - 전체 (gh + work + 3rd)"
    echo "    5) Git Review - 현재 디렉토리 ($(pwd))"
    echo ""
    echo -e "  ${YELLOW}System Info${NC}"
    echo "    6) 현재 디바이스 확인"
    echo "    7) 시스템 정보 요약"
    echo "    8) 날짜/시간 (서울 KST)"
    echo ""
    echo "    0) Exit"
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
}

# Execute Python tool
execute_py_tool() {
    local tool="$1"
    shift
    local args="$@"

    local tool_path="$SCRIPT_DIR/$tool"

    if [[ ! -f "$tool_path" ]]; then
        error "도구를 찾을 수 없습니다: $tool"
        return 1
    fi

    echo ""
    info "실행: $tool $args"
    echo ""

    python3 "$tool_path" $args
    local status=$?

    echo ""
    if [[ $status -eq 0 ]]; then
        success "완료!"
    else
        error "실패 (exit code: $status)"
    fi
    return $status
}

# Show current device
show_device() {
    local device_file="$HOME/.current-device"
    echo ""
    if [[ -f "$device_file" ]]; then
        local device=$(cat "$device_file")
        success "현재 디바이스: ${device^^}"
    else
        warn "디바이스 파일이 없습니다: $device_file"
        echo ""
        echo "다음 명령어로 설정하세요:"
        echo "  echo 'LAPTOP' > ~/.current-device"
        echo "  echo 'STORAGE-01' > ~/.current-device"
        echo "  echo 'GPU-01' > ~/.current-device"
    fi
    echo ""
}

# Show system info
show_system_info() {
    echo ""
    echo -e "${CYAN}━━━ System Information ━━━${NC}"
    echo ""

    # Hostname
    echo -e "${BLUE}Hostname:${NC} $(hostname)"

    # OS
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        echo -e "${BLUE}OS:${NC} $PRETTY_NAME"
    fi

    # Kernel
    echo -e "${BLUE}Kernel:${NC} $(uname -r)"

    # Uptime
    echo -e "${BLUE}Uptime:${NC} $(uptime -p)"

    # Current directory
    echo -e "${BLUE}PWD:${NC} $(pwd)"

    # Device
    if [[ -f "$HOME/.current-device" ]]; then
        echo -e "${BLUE}Device:${NC} $(cat $HOME/.current-device)"
    fi

    echo ""
}

# Show datetime
show_datetime() {
    echo ""
    local kst_time=$(TZ='Asia/Seoul' date '+%Y년 %m월 %d일 %A %H시 %M분 %S초')
    local denote_time=$(TZ='Asia/Seoul' date '+%Y%m%dT%H%M%S')

    echo -e "${CYAN}━━━ 현재 날짜/시간 (KST) ━━━${NC}"
    echo ""
    echo -e "${BLUE}현재:${NC} $kst_time"
    echo -e "${BLUE}Denote:${NC} $denote_time"
    echo ""
}

# Main loop
main() {
    # Check required tools
    if ! check_tool "python3"; then
        exit 1
    fi

    while true; do
        show_menu
        read -p "선택하세요 (0-8): " choice

        case $choice in
            1)
                if [[ -d "$REPOS_GH" ]]; then
                    execute_py_tool "greview.py" "$REPOS_GH"
                else
                    error "디렉토리가 없습니다: $REPOS_GH"
                fi
                ;;
            2)
                if [[ -d "$REPOS_WORK" ]]; then
                    execute_py_tool "greview.py" "$REPOS_WORK"
                else
                    error "디렉토리가 없습니다: $REPOS_WORK"
                fi
                ;;
            3)
                if [[ -d "$REPOS_3RD" ]]; then
                    execute_py_tool "greview.py" "$REPOS_3RD"
                else
                    error "디렉토리가 없습니다: $REPOS_3RD"
                fi
                ;;
            4)
                warn "전체 저장소를 검토합니다. 시간이 걸릴 수 있습니다."
                for repo_dir in "$REPOS_GH" "$REPOS_WORK" "$REPOS_3RD"; do
                    if [[ -d "$repo_dir" ]]; then
                        echo ""
                        info "━━━ $(basename $repo_dir) ━━━"
                        execute_py_tool "greview.py" "$repo_dir" || true
                    fi
                done
                ;;
            5)
                execute_py_tool "greview.py" "$(pwd)"
                ;;
            6)
                show_device
                ;;
            7)
                show_system_info
                ;;
            8)
                show_datetime
                ;;
            0)
                info "종료합니다."
                exit 0
                ;;
            *)
                error "잘못된 선택입니다."
                ;;
        esac

        echo ""
        read -p "계속하려면 Enter를 누르세요..."
    done
}

main "$@"
